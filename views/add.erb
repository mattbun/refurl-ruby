<!doctype html>

<html>
    <head>
        <title>Manage</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="components/jqueryfiletree/dist/jQueryFileTree.min.css">
        <script type="text/javascript" src="components/jquery/dist/jquery.min.js"></script>
        <script type="text/javascript" src="components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="components/jqueryfiletree/dist/jQueryFileTree.min.js"></script>
        <script type="text/javascript" src="components/jqueryfiletree/dist/jQueryFileTree.min.js"></script>
        <script type="text/javascript" src="components/clipboard-button/clipboard-button.js"></script>
        <script>

            $(document).ready( function() {
                $("#filelist-container").fileTree({
                    script: 'jqueryfiletree-connector',
                    multiFolder: false
                },
                function(file){
                    $("#path-field").val(file);
                });
            });

            function generateKey(){
                $.ajax({url : 'api/hash'}).done(function(data){
                    $('#key-field').val(data);
                });
            }

            function createLink(){
                var key = $("#key-field").val();

                var payload = {
                    "key" : key,
                    "name" : $("#name-field").val(),
                    "path" : $("#path-field").val()
                }

                $.post("api/add", payload, function(data){
                    console.log(data);
                    var result = JSON.parse(data);
                    if (result.status == "ok"){
                        window.location.href = result.key;
                        //$("#error-message").hide();
                        //$("#success-message").show();
                        //$("#success-message").html("<a href='" + result.key + "'>" + result.url + "</a> <button class='btn btn-primary btn-sm' id='clipboard-button' data-clipboard-text='" + result.url + "'><span class='glyphicon glyphicon-paperclip'></span></button>");
                        //$("#success-message").html("<a href='" + result.key + "'>" + result.url + "</a> <a class='btn btn-primary btn-sm' id='clipboard-button' data-clipboard-text='" + result.url + "'>(copy)</a>");
                        //$("#success-message").html('<div class="input-group"> <div class="input-group-btn"> <a href="' + result.key + '" class="btn btn-primary">Go</a></div> <input type="text" class="form-control" value="' + result.url + '"> <div class="input-group-btn"><button id="clipboard-button" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-paperclip"></span> </button> </div> </div>');
                        //clipboardButton("#clipboard-button");
                    }
                    else {
                        $("#success-message").hide();
                        $("#error-message").show();
                        $("#error-message").text(result.error);
                    }
                });
            }

            

        </script>
    </head>
  
  <body>
      <div class="container" style="width:750px; height:100%">
          <div class="navbar navbar-default">
              <div class="navbar-header">
                  <a class="navbar-brand" href="#">That</a>
              </div>
              <div class="collapse navbar-collapse">
                  <ul class="nav navbar-nav">
                      <li class="active">
                          <a href="that-add">Add</a>
                      </li>
                      <li>
                          <a href="that-manage">Manage</a>
                      </li>
                  </ul>
                  <ul class="nav navbar-nav navbar-right">
                      <!-- Someday? <li><a href="#">Settings</a></li> -->
                  </ul>
              </div>
          </div>

          <div style="float:left">
              <label class="form-label"><h4>Browse</h4></label>
              <div style="width:350px; height:500px; overflow:scroll" class="well">
                  <div id="filelist-container">
                  </div>
              </div>
              <input type="hidden" id="path-field" name="path" value="">
          </div>
          <div style="float:right; width:350px">
              <label class="form-label"><h4>Name</h4></label>
              <input id="name-field" type="text" class="form-control" name="name">
              <br>
              <label class="form-label"><h4>Key</h4></label>
              <div class="input-group">
                  <input id="key-field" type="text" class="form-control" name="key" value="<%= @hash %>">
                  <div class="input-group-btn">
                      <button type="button" class="btn btn-primary" onclick="generateKey()">
                          <span class="glyphicon glyphicon-refresh"></span>
                      </button>
                  </div>
              </div>
              <br>
              <br>
              <button id="create-button" class="btn btn-lg btn-block btn-primary" value="Create Link" onclick="createLink()">Create Link</button>
              <br>
              <br>
              <div style="color:red; text-align:center" id="error-message" hidden></div>
              <div style="text-align:center" id="success-message" hidden></div>
          </div>
      </div>
  </body>
</html>
